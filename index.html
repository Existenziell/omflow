<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>Omflow World Map</title>
	<meta name="viewport" content="initial-scale=1, maximum-scale=1" />

	<link rel="apple-touch-icon" sizes="180x180" href="img/favicon/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="img/favicon/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="img/favicon/favicon-16x16.png">
	<link rel="manifest" href="img/favicon/site.webmanifest">
	<link rel="mask-icon" href="img/favicon/safari-pinned-tab.svg" color="#5bbad5">
	<meta name="msapplication-TileColor" content="#da532c">
	<meta name="theme-color" content="#ffffff">

	<script src="data/places.json"></script>
	<script src="https://code.jquery.com/jquery-3.4.1.min.js"
		integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
		crossorigin="anonymous">
	</script>
	<script src="https://api.mapbox.com/mapbox-gl-js/v1.9.1/mapbox-gl.js"></script>
	<link href="https://api.mapbox.com/mapbox-gl-js/v1.9.1/mapbox-gl.css" rel="stylesheet" />
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.2.0/mapbox-gl-geocoder.min.js'></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.2.0/mapbox-gl-geocoder.css' type='text/css' />
    <!-- Promise polyfill script required to use Mapbox GL Geocoder in IE 11 -->
	<script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>
	<link rel="stylesheet" href="css/main.css" />
</head>
<body>
	<div id="overlay">
		<div class="overlay-button">
			<a href="javascript:void(0)" onclick="hideOverlay();">LOCATE AN OMIE</a>
		</div>
		<div class="overlay-button">
			<a href="matchme.html">LET'S OMFLOW</a>
		</div>
		<div class="overlay-button overlay-button-login">
			<a href="javascript:void(0)" onclick="showLoginLayer();">LOGIN</a>
		</div>
	</div>

	<div id="login-overlay">
		<div class="login-overlay-content">
			<h1>Enter your Omflow details</h1>
		</div>
	</div>

	<div id="map"></div>

	<script>

		mapboxgl.accessToken = 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw';

		// Create the map
		var map = new mapboxgl.Map({
			container: 'map',
			style: 'mapbox://styles/mapbox/satellite-v9', // satellite-v9 / light-v10 / dark-v10 / outdoors-v11
			zoom: 1.5
		});

		// Use custom Geocoder to include the features in places.json
		function forwardGeocoder(query) {
			var matchingFeatures = [];
			for (var i = 0; i < places.data.features.length; i++) {
				var feature = places.data.features[i];
				if (
					feature.id
					.toLowerCase()
					.search(query.toLowerCase()) !== -1
				) {
					feature['center'] = feature.geometry.coordinates;
					feature['place_name'] = '🙏 ' + feature.id;
					matchingFeatures.push(feature);
				}
			}
			return matchingFeatures;
		}

		// Add marker and popup to map for each feature in places.json
		function createMarkers() {
			places.data.features.forEach(function(marker) {
				var el = document.createElement('div');
				el.className = 'marker';

				new mapboxgl.Marker(el)
					.setLngLat(marker.geometry.coordinates)
					.setPopup(new mapboxgl.Popup({ offset: 15 })
					.setHTML(marker.properties.name + marker.properties.video + marker.properties.description))
					.addTo(map);
			});
		}

		function createGeo() {
			// Add the geocoder to the map
			var geocoder = new MapboxGeocoder({
				accessToken: mapboxgl.accessToken,
				localGeocoder: forwardGeocoder,
				marker: false,
				zoom: 5,
				placeholder: 'Search Omflow teacher',
				mapboxgl: mapboxgl
			});

			// Add geolocate control to the map.
			var geolocate = new mapboxgl.GeolocateControl({
				positionOptions: {
					enableHighAccuracy: true
				},
				trackUserLocation: true
			});

			map.addControl(geocoder);
			map.addControl(geolocate);

			// Open corresponding popup if result is clicked
			geocoder.on('result', function (e) {
				// Close all open popups
				$(".mapboxgl-popup").remove();
				// Create new poppup from result
			    var coords = e.result.geometry.coordinates;
			    var html = e.result.properties.name + e.result.properties.video + e.result.properties.description
			    var popup = new mapboxgl.Popup({ offset: 15 })
		        .setLngLat(coords)
		        .setHTML(html)
		        .addTo(map);
			});

			$('.mapboxgl-ctrl-geocoder--input').on('click focus', function() {
			    this.value = '';
			});
		}

		function hideOverlay() {
			document.getElementById('overlay').style.display = 'none';
			createMarkers();
			createGeo();
		}

		function showLoginLayer() {
			document.getElementById('login-overlay').style.display = 'flex';
		}
	</script>

</body>
</html>